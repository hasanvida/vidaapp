let imageBase64 = "";

const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const cameraBtn = document.getElementById("cameraBtn");
const camera = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const sendBtn = document.getElementById("sendBtn");
const resultContainer = document.getElementById("resultContainer");

// Handle file upload
fileInput.addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      imageBase64 = evt.target.result.split(",")[1];
      preview.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }
});

// Handle camera capture
cameraBtn.addEventListener("click", async function() {
  if (camera.style.display === "none") {
    camera.style.display = "block";
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    camera.srcObject = stream;
    cameraBtn.textContent = "Capture Photo";
  } else {
    const ctx = canvas.getContext("2d");
    canvas.width = camera.videoWidth;
    canvas.height = camera.videoHeight;
    ctx.drawImage(camera, 0, 0);
    imageBase64 = canvas.toDataURL("image/jpeg").split(",")[1];
    preview.src = canvas.toDataURL("image/jpeg");

    // Stop camera
    camera.srcObject.getTracks().forEach(track => track.stop());
    camera.style.display = "none";
    cameraBtn.textContent = "Take Photo";
  }
});

// Send image to Netlify function
sendBtn.addEventListener("click", function() {
  if (!imageBase64) {
    alert("Please upload or capture a KTP image first.");
    return;
  }

  fetch("/.netlify/functions/ocr", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ktp_image: imageBase64 })
  })
  .then(res => res.json())
  .then(data => {
    // Display full raw JSON response
    resultContainer.textContent = JSON.stringify(data, null, 2);
  })
  .catch(err => {
    resultContainer.textContent = "Error: " + err;
  });
});


